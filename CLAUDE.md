# Claude Development Guide - MTL Finder

This document contains important conventions, rules, and project structure information for MTL Finder.

## Project Overview

MTL Finder is an intelligent travel assistant for Montreal that combines:
- **Mistral AI** for natural language understanding and responses
- **OpenTripPlanner (OTP)** for multi-modal route planning
- **STM GTFS-RT** for real-time transit updates
- **BIXI GBFS** for bike-share availability
- **Open-Meteo** for weather data

## Git Commit Conventions

All commits must follow this format:

```
<type>(<scope>): <short description>

Examples:
- feat(backend): add STM alerts tool for real-time delays
- fix(frontend): correct location display formatting
- chore: update dependencies
- docs: add API documentation
```

### Types
- `feat`: New feature
- `fix`: Bug fix
- `chore`: Maintenance tasks
- `docs`: Documentation changes
- `refactor`: Code refactoring
- `test`: Test additions/changes
- `style`: Code formatting (no functional changes)

### Scopes
- `backend`: Backend API changes (src/backend/)
- `frontend`: Frontend UI changes (src/frontend/)
- `config`: Configuration files (docker-compose, OTP config, etc.)

### Rules
- **NO** Claude co-author attribution
- Keep commit messages concise and descriptive
- One logical change per commit
- Commit progressively, not all at once

## Project Structure

```
mistral-project/
├── src/
│   ├── backend/              # FastAPI backend
│   │   ├── main.py          # API server with Mistral integration
│   │   ├── tools.py         # Mistral AI function calling tools
│   │   └── pyproject.toml   # Backend dependencies (managed by uv)
│   └── frontend/            # Streamlit frontend
│       ├── main.py          # UI with geolocation
│       └── pyproject.toml   # Frontend dependencies (managed by uv)
├── otp-data/                # OpenTripPlanner data (gitignored)
│   └── graphs/montreal/
│       ├── build-config.json    # OTP build configuration
│       ├── router-config.json   # OTP routing parameters
│       ├── stm.gtfs.zip         # STM transit data
│       └── quebec.osm.pbf       # Quebec street network
├── .env                     # Environment variables (gitignored)
├── .env.example             # Environment template
├── docker-compose.otp.yml   # OTP Docker configuration
├── setup-otp.sh            # Download GTFS/OSM and create configs
├── start-otp.sh            # Start OTP with monitoring
└── restart-otp.sh          # Restart OTP after config changes
```

## Running the Application

### Backend
```bash
cd src/backend
uv run fastapi dev main.py
```
**Important**: Always use `uv run` to ensure dependencies are available!

### Frontend
```bash
cd src/frontend
uv run streamlit run main.py
```

### OpenTripPlanner
```bash
# First time setup
./setup-otp.sh

# Start OTP
./start-otp.sh

# After config changes
./restart-otp.sh
```

## Environment Variables

Required variables in `.env`:

```bash
# Backend
API_URL=http://localhost:8000
API_PORT=8000

# Frontend
FRONTEND_PORT=8501

# Mistral AI
MISTRAL_API_KEY=your_key_here
MISTRAL_MODEL=mistral-small-latest

# STM Real-time API
STM_API_KEY=your_key_here
```

### Getting API Keys

**STM API Key**:
1. Register at https://portail.developpeurs.stm.info/apihub
2. Create an application
3. Get the API key (NOT the client_secret)

**Mistral API Key**:
- Get from https://console.mistral.ai/

## OpenTripPlanner Configuration

### Build Configuration (`build-config.json`)

Generated by `setup-otp.sh` with:
- BIXI GBFS updater (60s refresh)
- STM GTFS-RT trip updates (30s refresh)
- STM API key from `.env`

**Important**: API key is inserted via environment variable substitution in `setup-otp.sh`

### Router Configuration (`router-config.json`)

Routing parameters:
- Bike rental enabled (BIXI)
- Walk speed: 1.3 m/s
- Bike speed: 5.0 m/s
- Car speed: 40 km/h
- Max 3 itineraries per request

## Tools Architecture

### Backend Tools (src/backend/tools.py)

Three Mistral AI function calling tools:

1. **get_weather(latitude, longitude)**
   - Uses Open-Meteo API
   - Returns current weather conditions

2. **plan_trip(from_lat, from_lon, to_lat, to_lon, mode)**
   - Uses OTP GraphQL API
   - Modes: TRANSIT,WALK, WALK, BICYCLE, CAR, TRANSIT
   - Returns 3 route options with real-time data

3. **get_stm_alerts(route_type)**
   - Uses STM GTFS-RT tripUpdates endpoint
   - Extracts delays > 2 minutes
   - Filters by: 'metro', 'bus', or 'all'

### System Prompt Strategy

The agent is instructed to:
1. Check STM alerts FIRST
2. Check weather
3. Plan the trip
4. Present options considering both weather and alerts

## Dependencies

Backend requires:
- fastapi
- uvicorn
- mistralai
- requests
- python-dotenv
- **gtfs-realtime-bindings** (for GTFS-RT parsing)

Frontend requires:
- streamlit
- requests
- streamlit-geolocation

Install with: `cd src/{backend|frontend} && uv sync`

## Common Issues

### "ModuleNotFoundError: No module named 'google.transit'"
**Solution**: Install in backend:
```bash
cd src/backend && uv add gtfs-realtime-bindings
```

### "Invalid API Key" from STM API
**Problem**: Using client_secret instead of API key
**Solution**: Get the actual API key from the STM portal (NOT the OAuth credentials)

### Frontend can't connect to backend
**Problem**: Backend not started with `uv run`
**Solution**: Always use `uv run fastapi dev main.py` in src/backend/

### OTP not showing real-time data
**Problem**: API key not configured in build-config.json
**Solution**: Re-run `./setup-otp.sh` after setting STM_API_KEY in .env

## Testing

To test the complete system:
1. Start OTP: `./start-otp.sh`
2. Start backend: `cd src/backend && uv run fastapi dev main.py`
3. Start frontend: `cd src/frontend && uv run streamlit run main.py`
4. Open browser to http://localhost:8501
5. Allow location access
6. Test a route query

## Todo List Tasks

Current pending tasks:
1. Test complete system with BIXI and STM alerts
2. Perform fresh deployment from scratch
3. Research hosting solution options

## Montreal Specific Data

### STM Metro Lines
- Line 1 (Green): Angrignon ↔ Honoré-Beaugrand
- Line 2 (Orange): Côte-Vertu ↔ Montmorency
- Line 4 (Yellow): Berri-UQAM ↔ Longueuil
- Line 5 (Blue): Snowdon ↔ Saint-Michel

### Common Destinations (Lat, Lon)
- Old Montreal: 45.5048, -73.5540
- McGill University: 45.5048, -73.5762
- Mont-Royal Park: 45.5048, -73.5874
- Plateau Mont-Royal: 45.5262, -73.5782
- Jean-Talon Market: 45.5356, -73.6135
- Olympic Stadium: 45.5579, -73.5516

## Additional Resources

- [STM Developer Portal](https://www.stm.info/en/about/developers)
- [OTP Documentation](http://docs.opentripplanner.org/)
- [Mistral AI Docs](https://docs.mistral.ai/)
- [GTFS-RT Specification](https://gtfs.org/realtime/)
